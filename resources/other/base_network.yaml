Resources:
  # VPC configuration
  MainVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 172.31.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
  # Subnet for VPC
  PrivateSubnet1:
    DependsOn: MainVPC
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MainVPC
      CidrBlock: 172.31.0.0/20
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs:
              Ref: AWS::Region
  PrivateSubnet2:
    DependsOn: MainVPC
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MainVPC
      CidrBlock: 172.31.16.0/20
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs:
              Ref: AWS::Region
  PrivateSubnet3:
    DependsOn: MainVPC
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MainVPC
      CidrBlock: 172.31.32.0/20
      AvailabilityZone:
        Fn::Select:
          - 2
          - Fn::GetAZs:
              Ref: AWS::Region
  PublicSubnet1:
    DependsOn: MainVPC
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MainVPC
      CidrBlock: 172.31.48.0/20
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs:
              Ref: AWS::Region
  PublicSubnet2:
    DependsOn: MainVPC
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MainVPC
      CidrBlock: 172.31.64.0/20
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs:
              Ref: AWS::Region
  PublicSubnet3:
    DependsOn: MainVPC
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MainVPC
      CidrBlock: 172.31.80.0/20
      AvailabilityZone:
        Fn::Select:
          - 2
          - Fn::GetAZs:
              Ref: AWS::Region
  # RouteTable
  PrivateRouteTable:
    DependsOn: MainVPC
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: MainVPC
  PublicRouteTable:
    DependsOn: MainVPC
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: MainVPC
  # Route Subnet association
  PrivateSubnet1RouteTableAssociation:
    DependsOn:
      - PrivateRouteTable
      - PrivateSubnet1
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnet1
      RouteTableId:
        Ref: PrivateRouteTable
  PrivateSubnet2RouteTableAssociation:
    DependsOn:
      - PrivateRouteTable
      - PrivateSubnet2
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnet2
      RouteTableId:
        Ref: PrivateRouteTable
  PrivateSubnet3RouteTableAssociation:
    DependsOn:
      - PrivateRouteTable
      - PrivateSubnet3
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnet3
      RouteTableId:
        Ref: PrivateRouteTable
  PublicSubnet1RouteTableAssociation:
    DependsOn:
      - PublicRouteTable
      - PublicSubnet1
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnet1
      RouteTableId:
        Ref: PublicRouteTable
  PublicSubnet2RouteTableAssociation:
    DependsOn:
      - PublicRouteTable
      - PublicSubnet2
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnet2
      RouteTableId:
        Ref: PublicRouteTable
  PublicSubnet3RouteTableAssociation:
    DependsOn:
      - PublicRouteTable
      - PublicSubnet3
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnet3
      RouteTableId:
        Ref: PublicRouteTable
  # InternetGateway for VPC
  InternetGateway:
    DependsOn: MainVPC
    Type: AWS::EC2::InternetGateway
  AttachInternetGateway:
    DependsOn:
      - MainVPC
      - InternetGateway
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: MainVPC
      InternetGatewayId:
        Ref: InternetGateway
  # NAT and Elastic IP for VPC
  EIP:
    DependsOn: MainVPC
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  NAT:
    DependsOn:
      - AttachInternetGateway
      - EIP
      - PrivateSubnet1
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - EIP
          - AllocationId
      SubnetId:
        Ref: PrivateSubnet1
  # Route Subnet association
  RouteToInternetGateway:
    DependsOn:
      - PublicRouteTable
      - InternetGateway
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
  RouteToNAT:
    DependsOn:
      - PrivateRouteTable
      - NAT
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NAT